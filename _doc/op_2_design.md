# Design {#chapter-design}

This chapter describes the design of the components of the system.
It shows how the user interaction is mapped to the softwares used, data storage structure and project files layout.



## Database Design

The following sub-sections show the database conceptual design.



### Source Data Import Table

The database is created and initially populated with the source data supplied during system setup and performed once at the start of the system operation. The source import table is structured as a standalone table whose structure is identical to the source data file structure.

The source data files are comma-separated value (CSV) files with a header line.
The following table shows the structure of the CSV file that is read by the system.

| Column No. | Column Name       | Data Type | Length |
|:----------:+-------------------+-----------+--------|
|      1     | province          | text      |   50   |
|      2     | district          | text      |   50   |
|      3     | municipality      | text      |   50   |
|      4     | municipality code | text      |   10   |
|      5     | barangay          | text      |   50   |
|      6     | precinct          | text      |   10   |
|      7     | voters            | numeric   |        |
|      8     | leader            | text      |  100   |
|      9     | contact           | text      |   50   |
|     10     | target            | numeric   |        |

The following clarifies some information on the source import table structure above.

1. The data in the `district` column is assumed to contain only abbreviations of ordinal numbers.
Ordinal number examples are `1st`, `2nd`, `3rd` and so on.
2. The `municipal code` column is assumed to contain only positive integral numbers.
3. The `voters` and `target` column is assumed to contain positive integral numbers.
4. The `voters` column is assumed to contain the number of voters.
5. The `target` column is assumed to contain a percentage value.
That means the column expects values from zero to a hundred percent (0-100).
The column does not expect a percentage (%) symbol.

The source data files are expected to be in UTF-8 encoding to accomodate special characters like the Spanish "enye", Ñ (lower case ñ).



### Subdivisions

The following diagram shows the structure and relationships of the geographical subdivisions and voting jurisdictions.
Note that the PSGC is not used here.

![Geographical subdivisions][image_geo]

\clearpage



### Poll Monitoring

The following diagram shows how the poll monitoring information has been structured.

![Operations][image_operations]

Note that the `target` column of the precinct monitor table does not hold a percentage value.
The percentage value from the import table is converted to an actual value using the utility function `get_percentage_value`.

[image_geo]: ./erd_geo.svg {width=400}
[image_operations]: ./erd_operations.svg {width=430}



## Operations



### Importing Source Data Files

Pre-Election Poll Monitoring System imports source data file(s) like geographical subdivisions, voting jurisdictions, number of registered voters and campaign leaders.

Maintainer imports the source data file(s) once on system setup.

!uml(images/pp-import-data.svg {width=550})(Import Source Data File(s))
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Maintainer -> "Import\nProgram" : import source data file(s)
"Import\nProgram" -> "Poll Database" : insert data into source import table
"Poll Database" -> "Poll Database" : distribute data from import table\ninto geographical subdivisions,\nvoting jurisdictions and\npoll monitoring tables.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\



The source data files are expected to be read from the import subdirectories `<project>/_data/to_import/...` and imported into PostgreSQL database using the `import.sh` driver script in the scripts directory `<project>/_scripts`. It is assumed that `region.csv` is in the `region` sub-directory, `province.csv` is in the `province` sub-directory and the district CSV files are in the `district` sub-directory.

See the [Project Files section](#section-project-files) for more details on the project directory structure.

To import the source data files into the database, a shell script is executed in the scripts directory, `<project>/_scripts`.

To create the database, import data the source data files and markdown files, the import script file is used:

~~~
$ ./import.sh
~~~

It is necessary during testing to generate mock data for the "In-Favor" values.
Mock data can be generated by executing the following script:

~~~
$ ./import.sh --mock <file>
~~~

If the `<file>` argument is not supplied, the default file `precinct_monitor_data.sql` in the `mock` script sub-directory is used.

See the [Import Script section](#section-import-script) for details.



### Assign Precinct Leader

Maintainer attempts to put a precinct voting jurisdiction under a leader's management.
Each precinct can only be under one leader.
Therefore, if the precinct is already under any other leader's management, the attempt fails.
Otherwise, the attempt succeeds and the precinct now belongs to the leader's management.

!uml(images/pp-assign-precinct-leader.svg {width=460})(Assign Precinct Leader)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Maintainer -> "Data Manager\nProgram" : Assign(leader id, precinct)
"Data Manager\nProgram" -> "Poll Database" : is valid (leader id, precint)

alt Valid Parameters

    "Data Manager\nProgram" -> "Poll Database" : add (leader id, precint)
    "Data Manager\nProgram" <- "Poll Database" : success

else

    "Data Manager\nProgram" -> Maintainer : Error: Invalid parameters

end
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\

To assign a precinct to a leader, use the data management script.



### Add In-Favor Message

Leader sends an SMS message to the Message Receiver.
The message denotes an In-Favor information for the candidate.
The Messager Receiver is expected to receive many SMS messages and collects them until some event is reached.
The event may be a certain cut-off time, a number of messages, or just manual intervention.

!uml(images/pp-send-in-favor-message.svg {width=240})(Send In-Favor Message)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Leader -> "Message\nReceiver" : send In-Favor message
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\



### Update Poll Database

The maintainer updates the poll database with the latest received messages from the Message Receiver collection.

!uml(images/pp-update-poll-database.svg {width=500})(Update Poll Database)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Maintainer -> "Message\nReceiver" : fetch set of messages
Maintainer <- "Message\nReceiver" : messages
Maintainer -> "Data Manager\nProgram" : update(messages)
"Data Manager\nProgram" -> "Poll Database" : save to temporary table
"Data Manager\nProgram" -> "Poll Database" : call validation procedure

alt Valid Messages

    "Data Manager\nProgram" -> "Poll Database" : Call update procedure

else

    "Poll Database" -> "Data Manager\nProgram" : Error: Invalid messages
    "Data Manager\nProgram" -> "Maintainer" : Error: Invalid messages

end
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\

To update the poll database, use the data management script.



### Exporting Data as JSON Files

To build these HTML files, Jekyll reads the JSON files in the data directory `<project>/_data`.
The following diagram shows the sequence of events and operations performed.

!uml(images/pp-create-json-files.svg {width=300})(Create JSON Files)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Maintainer -> "Create JSON\nProgram" : call
"Create JSON\nProgram" -> "Poll Database" : run queries
"Create JSON\nProgram" -> Maintainer : JSON files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To create all JSON files, execute the bash shell script file `create_json.sh` in the script directory `<project>/_scripts`.

~~~
$ ./create_json.sh
~~~

The output JSON files will be created in the data directory `<project>/_data`.



### Updating Local HTML Pages

The static web pages are automatically re-generated by Jekyll if one of the files have changed.
Also, the static web pages are re-generated every time Jekyll is executed.



### Updating Remote HTML Pages

The static web pages are automatically re-generated in the remote site when the project files are uploaded.

!uml(images/pp-update-remote-project-files.svg {width=420})(Update Remote Project Files)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Maintainer -> "Git\nProgram" : git push
"Git\nProgram" -> "Remote Site" : git sends the project\nfiles to the remote site

alt Success

    "Remote Site" -> "Remote Site" : generate files

else

    "Remote Site" -> "Maintainer" : remote site sends email\nnotification about failure

end
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\

To upload the latest project files to the remote site, the following command must be executed:

~~~
$ git push
~~~

If there is an error with the file generation in the remote site, the remote site will send an email notification of the event and information regarding the failure.



### View Poll Status

The poll status can be viewed as HTML pages from the remote site.
The generated HTML pages can be viewed using a browser in the following URL:

~~~
https://rmaicle.github.io/vtracker/
~~~



## Data Management

Data management handles all database query, insert and update operations.

The bash shell script, `dm.sh` in the scripts directory, `<project>/_scripts`, is the driver program for data management..

Query operations:

1. List all municipalities
2. Get precinct information
3. Get leader information
4. Get leader-precinct assignment

Insert and update operations:

1. Add new leader information
2. Set leader name
3. Set leader contact
4. Set leader-precinct assignment
5. Add to precinct current count
6. Set precinct current count
7. Set precinct target



### Parameter Wildcard

Certain query operations could display multiple rows of data depending on the value of the supplied parameters.
Parameters containing the wildcard character, percent (`%`), means any number of characters.
The wildcard could be a used as a prefix or a suffix or both.

Used as a prefix, `%abc` means any text ending with `abc`.
Used as a suffix, `abc%` means any text starting with `abc`.
Used as a prefix and a suffix, `%abc%` means any text containing the text `abc`.

The following table shows which satisfies the criteria column.

| Text     | %abc | abc% | %abc% |
|----------|:----:|:----:|:-----:|
| abc      | Yes  | Yes  | Yes   |
| abcde    | No   | Yes  | Yes   |
| 123abc   | Yes  | No   | Yes   |
| 123abcde | No   | No   | Yes   |

Parameters containing the wildcard character, underscore (`_`), means any one character.
The wildcard could be a used as a prefix or a suffix or both.

The criteria `abc_` means any text starting with `abc` with at least one character after it.
The criteria `abc__` means any text starting with `abc` with at least two characters after it.
The criteria `___abc` menas any text ending with `abc` and with three characters before it.

The following table shows which texts satisfies the criteria column.

| Text     | `abc_` | `abc__` | `___abc` |
|----------|:------:|:-------:|:--------:|
| abc      | No     | No      | No       |
| abcde    | No     | Yes     | No       |
| 123abc   | No     | No      | Yes      |
| 123abcde | No     | No      | No       |




### List all municipalities

The following lists all municipalities in alphabetical order.

~~~
$ ./dm.sh list-municipality
Municipality list
 id | municipality
----+--------------
  1 | ALAMADA
  2 | ALEOSAN
  7 | ANTIPAS
  8 | ARAKAN
 13 | BANISILAN
 14 | CARMEN
 15 | KABACAN
  9 | KIDAPAWAN
  3 | LIBUNGAN
 10 | MAGPET
 11 | MAKILALA
 16 | MATALAM
  4 | MIDSAYAP
 17 | MLANG
  5 | PIGKAWAYAN
  6 | PIKIT
 12 | PRES. ROXAS
 18 | TULUNAN
(18 rows)
~~~



### Get Precinct Information

Display precinct information.
The operation accepts either a precinct identifier or a precinct name.

The following displays the precinct information whose precinct identifier is `100`.

~~~
$ ./dm.sh get-precinct-info id 100
-[ RECORD 1 ]------+--------------------
district_id        | 1
district           | 1ST DISTRICT
municipality_id    | 1
municipality       | ALAMADA
barangay_id        | 231
barangay           | KITACUBONG
precinct_id        | 100
precinct           | 0010A
leader_id          | 12
leader             | ABRIQUE,NOEL   IBOT
contact            | 9166006445
current_count_sum  | 41
target_count_sum   | 138
current_percentage | 30
total_voters_sum   | 197
target_percentage  | 70
~~~

The following displays the precinct information whose precinct name is `0010A`.

~~~
$ ./dm.sh get-precinct-info name 0010A
-[ RECORD 1 ]------+------------------------------
district_id        | 1
district           | 1ST DISTRICT
municipality_id    | 1
municipality       | ALAMADA
barangay_id        | 231
barangay           | KITACUBONG
precinct_id        | 100
precinct           | 0010A
leader_id          | 12
leader             | ABRIQUE,NOEL   IBOT
contact            | 9166006445
current_count_sum  | 41
target_count_sum   | 138
current_percentage | 30
total_voters_sum   | 197
target_percentage  | 70
-[ RECORD 2 ]------+------------------------------
district_id        | 1
district           | 1ST DISTRICT
municipality_id    | 2
municipality       | ALEOSAN
barangay_id        | 473
barangay           | SAN MATEO
precinct_id        | 297
precinct           | 0010A
leader_id          | 209
leader             | BELANDA,ROSE   GUMAY
contact            | 9166006445
current_count_sum  | 55
target_count_sum   | 107
current_percentage | 51
total_voters_sum   | 153
target_percentage  | 70
...
~~~



### Get Leader Information

Display leader information.

The following displays the leader information whose leader identifier is `100`.

~~~
$ ./dm.sh get-leader-info id 100
Get leader information with 'id' equal to '100'.
 id  |          name          |  contact
-----+------------------------+------------
 100 | ANTONIO,ROWENA   DIOMA | 9166006445
(1 row)
~~~

The following displays leader information whose leader identifier ends with `10`.

~~~
$ ./dm.sh get-leader-info id '%10'
Get leader information with 'id' like '%10'.
 id  |             name             |  contact
-----+------------------------------+------------
  10 | ABOLO,DELIO   OBEJERO        | 9166006445
 110 | ARELLANO,JUDITH   MANALASTAS | 9166006445
 210 | BELMONTE                     | 9166006445
 310 | CLAVERIA,DEMETRIO  PACLIBAR  | 9166006445
 410 | FAJARDO,SALCHIL   ENCABO     | 9166006445
 510 | GUMAY,DIONY   BENATO         | 9166006445
 610 | LUMAGA,SHEILA   MAE  CASTOR  | 9166006445
(7 rows)
~~~

The following displays the leader information whose leader identifier starts with `11`.

~~~
$ ./dm.sh get-leader-info id '11%'
Get leader information with 'id' like '11%'.
 id  |             name             |  contact
-----+------------------------------+------------
  11 | ABOLO,MARITES   MONTAÑO      | 9166006445
 110 | ARELLANO,JUDITH   MANALASTAS | 9166006445
 111 | ARILLA,DANILO   SELLE        | 9166006445
 112 | ARNAIZ,MARIBEL   ANGAL       | 9166006445
 113 | ARNAIZ,MELBOY   MERMAL       | 9166006445
 114 | ARVADO,RENE   LANGOTE        | 9166006445
 115 | ARVADO,RODY   LANGOTE        | 9166006445
 116 | ARVADO,ROMY   LANGOTE        | 9166006445
 117 | ATILLO,DIVINA   PILASOR      | 9166006445
 118 | AVENIO,TERESITA   ESCODO     | 9166006445
 119 | AVENUE,JOVIE   VITUDIO       | 9166006445
(11 rows)
~~~

The following displays the leader information whose leader identifier starts with `11` and have at least one succeeding character.

~~~
$ ./dm.sh get-leader-info id '11%'
Get leader information with 'id' like '11_'.
 id  |             name             |  contact
-----+------------------------------+------------
 110 | ARELLANO,JUDITH   MANALASTAS | 9166006445
 111 | ARILLA,DANILO   SELLE        | 9166006445
 112 | ARNAIZ,MARIBEL   ANGAL       | 9166006445
 113 | ARNAIZ,MELBOY   MERMAL       | 9166006445
 114 | ARVADO,RENE   LANGOTE        | 9166006445
 115 | ARVADO,RODY   LANGOTE        | 9166006445
 116 | ARVADO,ROMY   LANGOTE        | 9166006445
 117 | ATILLO,DIVINA   PILASOR      | 9166006445
 118 | AVENIO,TERESITA   ESCODO     | 9166006445
 119 | AVENUE,JOVIE   VITUDIO       | 9166006445
(10 rows)
~~~



### Get Leader-Precinct Assignment

The following displays the precincts assigned to the specified leader.

~~~
$ ./dm.sh get-leader-assignment id 100
Get leader assignment with leader 'id' equal to '100'.
-[ RECORD 1 ]-------------------
id      | 100
name    | ANTONIO,ROWENA   DIOMA
contact | 9166006445

   district   | mun_id | municipality |  barangay  | prec_id | precinct
--------------+--------+--------------+------------+---------+----------
 1ST DISTRICT |      1 | ALAMADA      | GUILING    |      80 | 0066A
 1ST DISTRICT |      4 | MIDSAYAP     | MACASENDEG |     791 | 0185A
 1ST DISTRICT |      6 | PIKIT        | PANICUPAN  |    1511 | 0172A
 2ND DISTRICT |      7 | ANTIPAS      | MALATAB    |    1667 | 0051B
 2ND DISTRICT |      9 | KIDAPAWAN    | SINGAO     |    2402 | 0287A
 2ND DISTRICT |     12 | PRES. ROXAS  | MABUHAY    |    3076 | 0078A
 3RD DISTRICT |     13 | BANISILAN    | PANTAR     |    3247 | 0059B
 3RD DISTRICT |     16 | MATALAM      | KILADA     |    3940 | 0071C
 3RD DISTRICT |     18 | TULUNAN      | NEW CULASI |    4641 | 0106A

(9 rows)
~~~

\clearpage
